<!DOCTYPE html>
<html>
  <head>
    <title>Jiffies Tests</title>
    <base href="/" />
    <link rel="stylesheet" href="/pico/pico-1.4.1.css" />
  </head>
  <body>
    <header id="menu"></header>

    <main class="container">
      <article id="test_output"></article>
    </main>

    <div style="display: none" id="status"></div>
    <div style="display: none" id="json"></div>
    <div style="display: none" id="xml"></div>
    <script type="module" src="./jiffies/test_all.js"></script>
    <script type="module" src="./jiffies/dom/test.js"></script>
    <script type="module" src="./jiffies/components/test.js"></script>

    <script type="module">
      import { execute } from "./jiffies/scope/execute.js";
      import { displayStatistics } from "./jiffies/scope/display/dom.js";
      import { onConsole } from "./jiffies/scope/display/console.js";
      import { asXML } from "./jiffies/scope/display/junit.js";

      function write(id, value) {
        const start = `--- START_${id.toUpperCase()} ---`;
        const end = `--- END ---`;
        document.getElementById(
          id
        ).innerHTML = `\n${start}\n${value}\n${end}\n`;
      }

      (async () => {
        const results = await execute();
        displayStatistics(results, document.getElementById("test_output"));
        onConsole(results);
        write("status", results.failed);
        write("json", JSON.stringify(results));
        write("xml", asXML(results));
      })();
    </script>
    <script type="module">
      import { nav, ul, li, strong } from "./jiffies/dom/html.js";
      import { link } from "./jiffies/router/link.js";

      const getUrls = async () => {
        const sitemap = await fetch("/sitemap.json");
        if (sitemap.ok) {
          return await sitemap.json();
        } else {
          return [
            "/index.html",
            "/apps/computron5k/index.html",
            "/apps/chess/index.html",
          ];
        }
      };

      const urls = (await getUrls()).map((url) => ({
        href: url.replace("index.html", ""),
        link:
          url.match(/\/(?<link>[^\/]+)(\/index\.html)?$/)?.groups["link"] ??
          url.replace("index.html", ""),
      }));

      document
        .getElementById("menu")
        .appendChild(
          nav(
            ul(li(strong("Jiffy Apps"))),
            ul(...urls.map((url) => li(link(url))))
          )
        );
    </script>
  </body>
</html>
